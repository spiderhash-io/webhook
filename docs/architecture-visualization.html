<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Core Webhook Module — Architecture Visualization</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #06061a;
    color: #c8d6e5;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  #canvas { position: absolute; top: 0; left: 0; z-index: 1; }

  /* Header */
  #header {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 24px;
    background: linear-gradient(180deg, rgba(6,6,26,0.95) 0%, rgba(6,6,26,0.7) 80%, transparent 100%);
    pointer-events: none;
  }
  #header > * { pointer-events: auto; }
  #header h1 {
    font-size: 16px; font-weight: 600; letter-spacing: 0.5px;
    background: linear-gradient(90deg, #00e5ff, #7c4dff);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  #header .subtitle { font-size: 11px; color: #576574; margin-top: 2px; }

  /* View buttons */
  .view-btns { display: flex; gap: 6px; }
  .view-btn {
    padding: 6px 14px; border-radius: 6px; border: 1px solid #1a1a3e;
    background: rgba(20,20,50,0.8); color: #8395a7; font-size: 12px;
    cursor: pointer; transition: all 0.25s;
  }
  .view-btn:hover { border-color: #7c4dff; color: #ddd; }
  .view-btn.active {
    background: linear-gradient(135deg, rgba(124,77,255,0.2), rgba(0,229,255,0.15));
    border-color: #7c4dff; color: #fff;
  }

  /* Detail panel */
  #detail {
    position: fixed; right: -380px; top: 60px; bottom: 20px; width: 360px;
    z-index: 200; border-radius: 12px; overflow: hidden;
    background: rgba(10,10,35,0.92); border: 1px solid #1a1a3e;
    backdrop-filter: blur(12px); transition: right 0.35s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
  }
  #detail.open { right: 20px; }
  #detail-header {
    padding: 16px 20px; border-bottom: 1px solid #1a1a3e;
    display: flex; align-items: center; justify-content: space-between;
  }
  #detail-title { font-size: 15px; font-weight: 600; color: #fff; }
  #detail-close {
    width: 28px; height: 28px; border-radius: 6px; border: 1px solid #222;
    background: rgba(30,30,60,0.8); color: #8395a7; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 14px;
  }
  #detail-close:hover { border-color: #ff6b6b; color: #ff6b6b; }
  #detail-body { padding: 16px 20px; overflow-y: auto; flex: 1; font-size: 13px; line-height: 1.7; }
  #detail-body .label { color: #576574; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 14px; }
  #detail-body .label:first-child { margin-top: 0; }
  #detail-body .value { color: #ddd; margin-top: 2px; }
  #detail-body .filepath { color: #00e5ff; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
  #detail-body .conn-list { margin-top: 4px; }
  #detail-body .conn-item {
    display: inline-block; padding: 3px 8px; margin: 2px 4px 2px 0;
    border-radius: 4px; font-size: 11px;
    background: rgba(124,77,255,0.15); border: 1px solid rgba(124,77,255,0.3); color: #b8a9ff;
  }
  .category-badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
  }

  /* Legend */
  #legend {
    position: fixed; bottom: 20px; left: 20px; z-index: 100;
    background: rgba(10,10,35,0.85); border: 1px solid #1a1a3e;
    border-radius: 10px; padding: 14px 18px;
    backdrop-filter: blur(8px);
  }
  #legend h3 { font-size: 11px; color: #576574; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; font-size: 12px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Stats */
  #stats {
    position: fixed; bottom: 20px; right: 20px; z-index: 100;
    background: rgba(10,10,35,0.85); border: 1px solid #1a1a3e;
    border-radius: 10px; padding: 14px 18px; backdrop-filter: blur(8px);
    font-size: 12px; text-align: right;
    transition: right 0.35s cubic-bezier(0.4,0,0.2,1);
  }
  #stats.shifted { right: 400px; }
  .stat-row { display: flex; justify-content: space-between; gap: 20px; margin: 3px 0; }
  .stat-label { color: #576574; }
  .stat-value { color: #00e5ff; font-weight: 600; font-family: 'SF Mono', monospace; }

  /* Flow label */
  #flow-label {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    z-index: 100; font-size: 13px; color: #7c4dff; font-weight: 500;
    opacity: 0; transition: opacity 0.5s;
    text-align: center;
  }
  #flow-label.visible { opacity: 1; }

  /* Tooltip */
  #tooltip {
    position: fixed; z-index: 300; pointer-events: none;
    background: rgba(10,10,35,0.95); border: 1px solid #2a2a5e;
    border-radius: 8px; padding: 8px 12px; font-size: 12px;
    opacity: 0; transition: opacity 0.15s;
    max-width: 240px;
  }
  #tooltip.visible { opacity: 1; }
  #tooltip .tt-name { color: #fff; font-weight: 600; font-size: 13px; }
  #tooltip .tt-role { color: #8395a7; margin-top: 2px; font-size: 11px; }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="header">
  <div>
    <h1>Core Webhook Module</h1>
    <div class="subtitle">Interactive Architecture Visualization</div>
  </div>
  <div class="view-btns">
    <button class="view-btn active" data-view="overview">Overview</button>
    <button class="view-btn" data-view="flow">Request Flow</button>
    <button class="view-btn" data-view="modules">Modules</button>
    <button class="view-btn" data-view="config">Config System</button>
    <button class="view-btn" id="pause-btn" style="margin-left:12px">Pause</button>
  </div>
</div>

<div id="detail">
  <div id="detail-header">
    <span id="detail-title">Component</span>
    <button id="detail-close">&times;</button>
  </div>
  <div id="detail-body"></div>
</div>

<div id="legend">
  <h3>Components</h3>
  <div class="legend-item"><div class="legend-dot" style="background:#00e5ff"></div> Entry / Core</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b"></div> Authentication</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ffa502"></div> Processing</div>
  <div class="legend-item"><div class="legend-dot" style="background:#2ed573"></div> Output Modules</div>
  <div class="legend-item"><div class="legend-dot" style="background:#7c4dff"></div> Configuration</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff6348"></div> Webhook Connect</div>
  <div class="legend-item"><div class="legend-dot" style="background:#1e90ff"></div> Connector</div>
</div>

<div id="stats">
  <div class="stat-row"><span class="stat-label">Python files</span><span class="stat-value">30+</span></div>
  <div class="stat-row"><span class="stat-label">Auth methods</span><span class="stat-value">11</span></div>
  <div class="stat-row"><span class="stat-label">Output modules</span><span class="stat-value">18</span></div>
  <div class="stat-row"><span class="stat-label">Tests</span><span class="stat-value">3100+</span></div>
</div>

<div id="flow-label"></div>
<div id="tooltip"><div class="tt-name"></div><div class="tt-role"></div></div>

<script>
// ── DATA ──────────────────────────────────────────────────────────────
const CATEGORIES = {
  entry:   { color: '#00e5ff', glow: 'rgba(0,229,255,0.35)',  label: 'Entry' },
  auth:    { color: '#ff6b6b', glow: 'rgba(255,107,107,0.35)', label: 'Auth' },
  process: { color: '#ffa502', glow: 'rgba(255,165,2,0.35)',   label: 'Processing' },
  module:  { color: '#2ed573', glow: 'rgba(46,213,115,0.35)',  label: 'Output Module' },
  config:  { color: '#7c4dff', glow: 'rgba(124,77,255,0.35)',  label: 'Config' },
  wc:      { color: '#ff6348', glow: 'rgba(255,99,72,0.35)',   label: 'Webhook Connect' },
  conn:    { color: '#1e90ff', glow: 'rgba(30,144,255,0.35)',  label: 'Connector' },
};

// Node definitions
const NODES = [
  // Entry
  { id: 'http',          label: 'HTTP Request',      cat: 'entry',   file: null,                         desc: 'Incoming webhook HTTP request from external services', size: 22 },
  { id: 'main',          label: 'main.py',            cat: 'entry',   file: 'src/main.py',                desc: 'FastAPI application. Routes, middleware (CORS, security headers), startup/shutdown lifecycle, health & admin endpoints.', size: 26 },
  { id: 'rate_limiter',  label: 'RateLimiter',        cat: 'process', file: 'src/rate_limiter.py',        desc: 'Sliding-window rate limiting per webhook endpoint. Configurable window size and max requests.', size: 16 },
  { id: 'webhook',       label: 'WebhookHandler',     cat: 'entry',   file: 'src/webhook.py',             desc: 'Core orchestrator: validates auth, parses payload, routes to modules or chain processor. Contains TaskManager for async execution.', size: 24 },
  { id: 'task_mgr',      label: 'TaskManager',        cat: 'process', file: 'src/webhook.py',             desc: 'Bounded async task execution with semaphore concurrency control and timeout protection.', size: 14 },

  // Auth validators
  { id: 'input_val',     label: 'InputValidator',     cat: 'auth',    file: 'src/input_validator.py',     desc: 'Payload size (10MB), JSON depth (50), string length (1MB), header count/size validation. Prevents DoS.', size: 16 },
  { id: 'validators',    label: 'Validators (11)',     cat: 'auth',    file: 'src/validators.py',          desc: '11 auth methods: Bearer, Basic, HMAC-SHA256, JWT, IP whitelist, reCAPTCHA, Rate Limit, Query Param, Header, OAuth2, Digest. All use constant-time comparison.', size: 20 },
  { id: 'v_bearer',      label: 'Bearer',             cat: 'auth',    file: 'src/validators.py',          desc: 'Authorization header Bearer token validation with constant-time comparison.', size: 10 },
  { id: 'v_basic',       label: 'Basic Auth',         cat: 'auth',    file: 'src/validators.py',          desc: 'HTTP Basic Authentication with Base64 decoding and credential verification.', size: 10 },
  { id: 'v_hmac',        label: 'HMAC',               cat: 'auth',    file: 'src/validators.py',          desc: 'HMAC-SHA256 signature validation using hmac.compare_digest() for timing-safe comparison.', size: 10 },
  { id: 'v_jwt',         label: 'JWT',                cat: 'auth',    file: 'src/validators.py',          desc: 'JSON Web Token validation supporting RS256 and HS256 algorithms with claims verification.', size: 10 },
  { id: 'v_ip',          label: 'IP Whitelist',       cat: 'auth',    file: 'src/validators.py',          desc: 'Client IP address whitelist validation with CIDR range support and proxy awareness.', size: 10 },
  { id: 'v_oauth',       label: 'OAuth2',             cat: 'auth',    file: 'src/validators.py',          desc: 'OAuth 2.0 token introspection and validation against authorization servers.', size: 10 },
  { id: 'v_recaptcha',   label: 'reCAPTCHA',          cat: 'auth',    file: 'src/validators.py',          desc: 'Google reCAPTCHA v3 token verification for bot protection.', size: 10 },
  { id: 'v_header',      label: 'Header Auth',        cat: 'auth',    file: 'src/validators.py',          desc: 'Custom header-based authentication with injection prevention.', size: 10 },
  { id: 'v_query',       label: 'Query Param',        cat: 'auth',    file: 'src/validators.py',          desc: 'URL query parameter-based authentication with constant-time comparison.', size: 10 },
  { id: 'v_digest',      label: 'Digest Auth',        cat: 'auth',    file: 'src/validators.py',          desc: 'HTTP Digest Authentication with nonce validation and replay protection.', size: 10 },
  { id: 'v_ratelim',     label: 'Rate Limit',         cat: 'auth',    file: 'src/validators.py',          desc: 'Per-webhook rate limit enforcement as a validation step.', size: 10 },

  // Processing
  { id: 'registry',      label: 'ModuleRegistry',     cat: 'process', file: 'src/modules/registry.py',    desc: 'Plugin registry: maps module names to classes. Security validation (no path traversal, 64 char limit). 18 registered modules.', size: 20 },
  { id: 'chain',         label: 'ChainProcessor',     cat: 'process', file: 'src/chain_processor.py',     desc: 'Multi-module orchestration: sequential or parallel execution. Continue-on-error, timeout protection, resource limits.', size: 18 },
  { id: 'chain_val',     label: 'ChainValidator',     cat: 'process', file: 'src/chain_validator.py',     desc: 'Validates chain configurations: checks module names, normalizes chain items, enforces security constraints.', size: 14 },
  { id: 'retry',         label: 'RetryHandler',       cat: 'process', file: 'src/retry_handler.py',       desc: 'Exponential backoff retry with jitter. Max 20 attempts, 60s max delay. Prevents thundering herd.', size: 14 },
  { id: 'base_mod',      label: 'BaseModule',         cat: 'process', file: 'src/modules/base.py',        desc: 'Abstract base class for all output modules. Enforces process()/setup()/teardown() interface. Config type validation in __init__.', size: 16 },

  // Output modules
  { id: 'm_log',         label: 'log',                cat: 'module',  file: 'src/modules/log.py',                    desc: 'Console/file logging with pretty printing and sensitive data redaction.', size: 13 },
  { id: 'm_disk',        label: 'save_to_disk',       cat: 'module',  file: 'src/modules/save_to_disk.py',           desc: 'File system storage with directory creation, file naming, JSON/binary modes.', size: 13 },
  { id: 'm_rabbitmq',    label: 'rabbitmq',           cat: 'module',  file: 'src/modules/rabbitmq.py',               desc: 'RabbitMQ producer with connection pooling, dynamic exchange/routing key support.', size: 13 },
  { id: 'm_redis_rq',    label: 'redis_rq',           cat: 'module',  file: 'src/modules/redis_rq.py',               desc: 'Redis RQ job queueing with dynamic job function whitelisting.', size: 13 },
  { id: 'm_redis_pub',   label: 'redis_publish',      cat: 'module',  file: 'src/modules/redis_publish.py',          desc: 'Redis Pub/Sub channel publishing.', size: 13 },
  { id: 'm_http',        label: 'http_webhook',       cat: 'module',  file: 'src/modules/http_webhook.py',           desc: 'HTTP POST forwarding with automatic retry, custom headers, SSRF protection, timeout handling.', size: 13 },
  { id: 'm_kafka',       label: 'kafka',              cat: 'module',  file: 'src/modules/kafka.py',                  desc: 'Apache Kafka producer with topic publishing and key-value pairs.', size: 13 },
  { id: 'm_s3',          label: 's3',                 cat: 'module',  file: 'src/modules/s3.py',                     desc: 'AWS S3 object storage with bucket operations and key naming.', size: 13 },
  { id: 'm_ws',          label: 'websocket',          cat: 'module',  file: 'src/modules/websocket.py',              desc: 'WebSocket forwarding with connection management.', size: 13 },
  { id: 'm_click',       label: 'clickhouse',         cat: 'module',  file: 'src/modules/clickhouse.py',             desc: 'ClickHouse table insertion with automatic schema detection and timestamp injection.', size: 13 },
  { id: 'm_mqtt',        label: 'mqtt',               cat: 'module',  file: 'src/modules/mqtt.py',                   desc: 'MQTT broker publishing with QoS levels and topic support.', size: 13 },
  { id: 'm_zmq',         label: 'zeromq',             cat: 'module',  file: 'src/modules/zeromq.py',                 desc: 'ZeroMQ socket publishing with socket type selection and async handling.', size: 13 },
  { id: 'm_amq',         label: 'activemq',           cat: 'module',  file: 'src/modules/activemq.py',               desc: 'Apache ActiveMQ publishing to queues and topics.', size: 13 },
  { id: 'm_sqs',         label: 'aws_sqs',            cat: 'module',  file: 'src/modules/aws_sqs.py',                desc: 'AWS SQS queue publishing with message attributes and batch operations.', size: 13 },
  { id: 'm_gcp',         label: 'gcp_pubsub',         cat: 'module',  file: 'src/modules/gcp_pubsub.py',             desc: 'Google Cloud Pub/Sub topic publishing with attribute support.', size: 13 },
  { id: 'm_pg',          label: 'postgres',           cat: 'module',  file: 'src/modules/postgres.py',               desc: 'PostgreSQL dynamic table inserts with connection pooling.', size: 13 },
  { id: 'm_mysql',       label: 'mysql',              cat: 'module',  file: 'src/modules/mysql.py',                  desc: 'MySQL dynamic table inserts with connection pooling.', size: 13 },
  { id: 'm_wc',          label: 'webhook_connect',    cat: 'module',  file: 'src/modules/webhook_connect_module.py', desc: 'Cloud-to-local relay module: delivers webhooks to connected local clients.', size: 13 },

  // Config
  { id: 'cfg_mgr',       label: 'ConfigManager',      cat: 'config',  file: 'src/config_manager.py',         desc: 'Factory for file/etcd backends. Live reload orchestration, config validation, pool management coordination.', size: 20 },
  { id: 'cfg_provider',  label: 'ConfigProvider',     cat: 'config',  file: 'src/config_provider.py',        desc: 'Abstract base class (ABC): read-only interface for config backends. Defines get/list/status contract.', size: 14 },
  { id: 'cfg_file',      label: 'FileConfigProvider', cat: 'config',  file: 'src/file_config_provider.py',   desc: 'JSON file loading with env var substitution ({$VAR} syntax). Hot-reload support.', size: 14 },
  { id: 'cfg_etcd',      label: 'EtcdConfigProvider', cat: 'config',  file: 'src/etcd_config_provider.py',   desc: 'etcd backend: in-memory cache, real-time watch thread, auto reconnection with backoff, namespace support.', size: 14 },
  { id: 'pool_reg',      label: 'ConnectionPoolRegistry', cat: 'config', file: 'src/connection_pool_registry.py', desc: 'Connection pool lifecycle: versioned pools, graceful migration, zero-downtime config reloads. Manages RabbitMQ, Redis, PostgreSQL, MySQL pools.', size: 16 },
  { id: 'cfg_watch',     label: 'ConfigWatcher',      cat: 'config',  file: 'src/config_watcher.py',         desc: 'File change detection via watchdog. Debounced reload triggers.', size: 12 },
  { id: 'vault',         label: 'VaultResolver',      cat: 'config',  file: 'src/vault_secret_resolver.py',  desc: 'HashiCorp Vault integration: resolves {$vault:path} placeholders from Vault secrets engine.', size: 12 },

  // Analytics / Utils
  { id: 'analytics',     label: 'ClickHouseAnalytics',cat: 'process', file: 'src/clickhouse_analytics.py',   desc: 'Async event logging to ClickHouse for distributed analytics. Connect/save/disconnect lifecycle.', size: 14 },
  { id: 'utils',         label: 'Utils',              cat: 'process', file: 'src/utils.py',                  desc: 'Shared utilities: sanitize_error_message, load_env_vars, safe_decode_body, CredentialCleaner, RedisEndpointStats, get_client_ip.', size: 14 },
  { id: 'openapi',       label: 'OpenAPI Gen',        cat: 'process', file: 'src/openapi_generator.py',      desc: 'Dynamic OpenAPI/Swagger schema generation from webhook configuration.', size: 12 },

  // Webhook Connect subsystem
  { id: 'wc_channel',    label: 'ChannelManager',     cat: 'wc',      file: 'src/webhook_connect/channel_manager.py', desc: 'Channel lifecycle: create, deliver messages, close. Manages connected client streams.', size: 16 },
  { id: 'wc_api',        label: 'Stream API',         cat: 'wc',      file: 'src/webhook_connect/api.py',             desc: 'Streaming endpoints: /wc/stream (WebSocket/SSE/Long-Poll), /wc/reconnect.', size: 14 },
  { id: 'wc_admin',      label: 'Admin API',          cat: 'wc',      file: 'src/webhook_connect/admin_api.py',       desc: 'Admin management endpoints: /wc/admin/* for channel monitoring and control.', size: 12 },
  { id: 'wc_models',     label: 'Models',             cat: 'wc',      file: 'src/webhook_connect/models.py',          desc: 'Data models: Channel, Message, Stream data structures.', size: 10 },
  { id: 'wc_buf_redis',  label: 'Redis Buffer',       cat: 'wc',      file: 'src/webhook_connect/buffer/redis_buffer.py',    desc: 'Redis-backed message buffer for webhook relay persistence.', size: 10 },
  { id: 'wc_buf_rmq',    label: 'RabbitMQ Buffer',    cat: 'wc',      file: 'src/webhook_connect/buffer/rabbitmq_buffer.py', desc: 'RabbitMQ-backed message buffer for webhook relay persistence.', size: 10 },

  // Connector subsystem
  { id: 'cn_main',       label: 'Connector Main',     cat: 'conn',    file: 'src/connector/main.py',             desc: 'Standalone local service entrypoint. Receives relayed webhooks and dispatches locally.', size: 16 },
  { id: 'cn_stream',     label: 'StreamClient',       cat: 'conn',    file: 'src/connector/stream_client.py',    desc: 'Cloud connection client: WebSocket/SSE/long-poll modes for receiving relayed webhooks.', size: 14 },
  { id: 'cn_proc',       label: 'MessageProcessor',   cat: 'conn',    file: 'src/connector/processor.py',        desc: 'Message delivery processor: process messages, handle retries, send ACKs. InFlightMessage tracking.', size: 14 },
  { id: 'cn_modproc',    label: 'ModuleProcessor',    cat: 'conn',    file: 'src/connector/module_processor.py', desc: 'Module dispatch: forward messages to internal modules (kafka, save_to_disk, etc.).', size: 12 },
  { id: 'cn_config',     label: 'ConnectorConfig',    cat: 'conn',    file: 'src/connector/config.py',           desc: 'Connector configuration: ConnectorConfig and TargetConfig classes. HTTP/Module/etcd mode settings.', size: 12 },
];

// Edges (from -> to)
const EDGES = [
  // Main request flow
  { from: 'http',        to: 'main',       flow: true,  label: 'HTTP POST' },
  { from: 'main',        to: 'rate_limiter',flow: true },
  { from: 'main',        to: 'webhook',    flow: true,  label: 'process request' },
  { from: 'webhook',     to: 'validators', flow: true,  label: 'authenticate' },
  { from: 'webhook',     to: 'input_val',  flow: true,  label: 'validate payload' },
  { from: 'webhook',     to: 'task_mgr',   flow: false },
  { from: 'webhook',     to: 'registry',   flow: true,  label: 'lookup module' },
  { from: 'webhook',     to: 'chain',      flow: true,  label: 'chain execution' },

  // Validators detail
  { from: 'validators', to: 'v_bearer',    flow: false },
  { from: 'validators', to: 'v_basic',     flow: false },
  { from: 'validators', to: 'v_hmac',      flow: false },
  { from: 'validators', to: 'v_jwt',       flow: false },
  { from: 'validators', to: 'v_ip',        flow: false },
  { from: 'validators', to: 'v_oauth',     flow: false },
  { from: 'validators', to: 'v_recaptcha', flow: false },
  { from: 'validators', to: 'v_header',    flow: false },
  { from: 'validators', to: 'v_query',     flow: false },
  { from: 'validators', to: 'v_digest',    flow: false },
  { from: 'validators', to: 'v_ratelim',   flow: false },

  // Chain processor
  { from: 'chain',       to: 'chain_val',  flow: false },
  { from: 'chain',       to: 'registry',   flow: true,  label: 'get modules' },
  { from: 'chain',       to: 'retry',      flow: true,  label: 'retry on failure' },

  // Registry to modules
  { from: 'registry',    to: 'base_mod',   flow: false },
  { from: 'registry',    to: 'm_log',      flow: true },
  { from: 'registry',    to: 'm_disk',     flow: true },
  { from: 'registry',    to: 'm_rabbitmq', flow: true },
  { from: 'registry',    to: 'm_redis_rq', flow: true },
  { from: 'registry',    to: 'm_redis_pub',flow: true },
  { from: 'registry',    to: 'm_http',     flow: true },
  { from: 'registry',    to: 'm_kafka',    flow: true },
  { from: 'registry',    to: 'm_s3',       flow: true },
  { from: 'registry',    to: 'm_ws',       flow: true },
  { from: 'registry',    to: 'm_click',    flow: true },
  { from: 'registry',    to: 'm_mqtt',     flow: true },
  { from: 'registry',    to: 'm_zmq',      flow: true },
  { from: 'registry',    to: 'm_amq',      flow: true },
  { from: 'registry',    to: 'm_sqs',      flow: true },
  { from: 'registry',    to: 'm_gcp',      flow: true },
  { from: 'registry',    to: 'm_pg',       flow: true },
  { from: 'registry',    to: 'm_mysql',    flow: true },
  { from: 'registry',    to: 'm_wc',       flow: true },

  // Config system
  { from: 'main',        to: 'cfg_mgr',    flow: false },
  { from: 'cfg_mgr',     to: 'cfg_provider', flow: false },
  { from: 'cfg_provider',to: 'cfg_file',   flow: false },
  { from: 'cfg_provider',to: 'cfg_etcd',   flow: false },
  { from: 'cfg_mgr',     to: 'pool_reg',   flow: false },
  { from: 'cfg_mgr',     to: 'cfg_watch',  flow: false },
  { from: 'cfg_file',    to: 'vault',      flow: false },
  { from: 'cfg_file',    to: 'utils',      flow: false },

  // Analytics
  { from: 'main',        to: 'analytics',  flow: false },
  { from: 'main',        to: 'openapi',    flow: false },
  { from: 'webhook',     to: 'utils',      flow: false },

  // Webhook Connect
  { from: 'm_wc',        to: 'wc_channel', flow: true,  label: 'deliver' },
  { from: 'wc_channel',  to: 'wc_api',     flow: true,  label: 'stream' },
  { from: 'wc_channel',  to: 'wc_models',  flow: false },
  { from: 'wc_channel',  to: 'wc_buf_redis',flow: false },
  { from: 'wc_channel',  to: 'wc_buf_rmq', flow: false },
  { from: 'main',        to: 'wc_admin',   flow: false },
  { from: 'wc_api',      to: 'wc_models',  flow: false },

  // Connector
  { from: 'wc_api',      to: 'cn_stream',  flow: true,  label: 'relay' },
  { from: 'cn_stream',   to: 'cn_main',    flow: true },
  { from: 'cn_main',     to: 'cn_proc',    flow: true },
  { from: 'cn_main',     to: 'cn_modproc', flow: true },
  { from: 'cn_main',     to: 'cn_config',  flow: false },
  { from: 'cn_modproc',  to: 'registry',   flow: true,  label: 'dispatch' },

  // Pool registry connections
  { from: 'pool_reg',    to: 'm_rabbitmq', flow: false },
  { from: 'pool_reg',    to: 'm_redis_rq', flow: false },
  { from: 'pool_reg',    to: 'm_pg',       flow: false },
  { from: 'pool_reg',    to: 'm_mysql',    flow: false },
];

// ── LAYOUT ────────────────────────────────────────────────────────────
const VIEWS = {
  overview: {
    // All nodes visible, hierarchical layout
    positions: {},
    visible: null, // null = all
    title: 'System Overview',
    flowSteps: null,
  },
  flow: {
    positions: {},
    visible: ['http','main','rate_limiter','webhook','task_mgr','input_val','validators','registry','chain','chain_val','retry','base_mod',
      'm_log','m_disk','m_rabbitmq','m_redis_rq','m_redis_pub','m_http','m_kafka','m_s3','m_ws','m_click','m_mqtt','m_zmq','m_amq','m_sqs','m_gcp','m_pg','m_mysql','m_wc'],
    title: 'Request Processing Flow',
    flowSteps: [
      { nodes: ['http'], label: '1. HTTP request arrives' },
      { nodes: ['main'], label: '2. FastAPI routes to handler' },
      { nodes: ['rate_limiter'], label: '3. Rate limit check' },
      { nodes: ['webhook'], label: '4. WebhookHandler processes' },
      { nodes: ['validators','input_val'], label: '5. Auth + Input validation' },
      { nodes: ['registry','chain'], label: '6. Module lookup / Chain processing' },
      { nodes: ['m_log','m_disk','m_rabbitmq','m_redis_rq','m_redis_pub','m_http','m_kafka','m_s3','m_ws','m_click','m_mqtt','m_zmq','m_amq','m_sqs','m_gcp','m_pg','m_mysql','m_wc'], label: '7. Payload delivered to output' },
    ],
  },
  modules: {
    positions: {},
    visible: ['registry','base_mod','m_log','m_disk','m_rabbitmq','m_redis_rq','m_redis_pub','m_http','m_kafka','m_s3','m_ws','m_click','m_mqtt','m_zmq','m_amq','m_sqs','m_gcp','m_pg','m_mysql','m_wc','pool_reg','chain','retry','chain_val'],
    title: '18 Output Modules',
    flowSteps: null,
  },
  config: {
    positions: {},
    visible: ['cfg_mgr','cfg_provider','cfg_file','cfg_etcd','pool_reg','cfg_watch','vault','utils','main'],
    title: 'Configuration System',
    flowSteps: null,
  },
};

// ── STATE ─────────────────────────────────────────────────────────────
let canvas, ctx, W, H, dpr;
let currentView = 'overview';
let nodeMap = {};        // id -> runtime node object
let particles = [];
let hoveredNode = null;
let selectedNode = null;
let animFrame;
let time = 0;
let flowStep = -1;
let flowTimer = 0;
let cameraX = 0, cameraY = 0, cameraScale = 1;
let isDragging = false, dragNode = null, dragOffX = 0, dragOffY = 0;
let isPanning = false, panStartX = 0, panStartY = 0, panCamStartX = 0, panCamStartY = 0;
let paused = false;

// ── INITIALIZE ────────────────────────────────────────────────────────
function init() {
  canvas = document.getElementById('canvas');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);

  // Build node map
  NODES.forEach(n => {
    nodeMap[n.id] = { ...n, x: 0, y: 0, tx: 0, ty: 0, alpha: 0, talpha: 1, scale: 0, tscale: 1, hover: 0 };
  });

  computeAllLayouts();
  restorePositions();
  setView('overview');
  bindEvents();
  animate();
}

function resize() {
  dpr = window.devicePixelRatio || 1;
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  computeAllLayouts();
  restorePositions();
}

// ── LAYOUTS ───────────────────────────────────────────────────────────
function computeAllLayouts() {
  const cx = W / 2, cy = H / 2;
  const moduleIds = ['m_log','m_disk','m_rabbitmq','m_redis_rq','m_redis_pub','m_http','m_kafka','m_s3','m_ws','m_click','m_mqtt','m_zmq','m_amq','m_sqs','m_gcp','m_pg','m_mysql','m_wc'];
  const validatorIds = ['v_bearer','v_basic','v_hmac','v_jwt','v_ip','v_oauth','v_recaptcha','v_header','v_query','v_digest','v_ratelim'];
  const wcIds = ['wc_channel','wc_api','wc_admin','wc_models','wc_buf_redis','wc_buf_rmq'];
  const cnIds = ['cn_main','cn_stream','cn_proc','cn_modproc','cn_config'];

  // ─── OVERVIEW LAYOUT ───
  const ov = VIEWS.overview.positions;
  const oTop = 80, oSpacing = 80;

  ov['http']         = { x: cx, y: oTop };
  ov['main']         = { x: cx, y: oTop + oSpacing };
  ov['rate_limiter'] = { x: cx - 160, y: oTop + oSpacing * 1.7 };
  ov['webhook']      = { x: cx, y: oTop + oSpacing * 2 };
  ov['task_mgr']     = { x: cx + 160, y: oTop + oSpacing * 1.7 };

  ov['input_val']    = { x: cx - 120, y: oTop + oSpacing * 2.8 };
  ov['validators']   = { x: cx + 120, y: oTop + oSpacing * 2.8 };

  // Validators fanned out
  const vStartX = cx + 240, vY = oTop + oSpacing * 3.5;
  validatorIds.forEach((id, i) => {
    const angle = -0.8 + (i / (validatorIds.length - 1)) * 1.6;
    ov[id] = { x: vStartX + Math.sin(angle) * 140, y: vY + i * 24 };
  });

  ov['registry']     = { x: cx - 60, y: oTop + oSpacing * 3.8 };
  ov['chain']        = { x: cx + 60, y: oTop + oSpacing * 3.8 };
  ov['chain_val']    = { x: cx + 180, y: oTop + oSpacing * 3.8 };
  ov['retry']        = { x: cx + 130, y: oTop + oSpacing * 4.3 };
  ov['base_mod']     = { x: cx - 200, y: oTop + oSpacing * 3.8 };

  // Output modules in arc
  const mCx = cx, mCy = oTop + oSpacing * 6.2;
  const mSpread = Math.min(W * 0.42, 460);
  moduleIds.forEach((id, i) => {
    const t = i / (moduleIds.length - 1);
    ov[id] = { x: mCx - mSpread + t * mSpread * 2, y: mCy + Math.sin(t * Math.PI) * 50 - 20 };
  });

  // Config on the left
  const cfgX = 160, cfgY = oTop + oSpacing * 2;
  ov['cfg_mgr']      = { x: cfgX, y: cfgY };
  ov['cfg_provider']  = { x: cfgX - 40, y: cfgY + 70 };
  ov['cfg_file']      = { x: cfgX - 80, y: cfgY + 140 };
  ov['cfg_etcd']      = { x: cfgX + 20, y: cfgY + 140 };
  ov['pool_reg']      = { x: cfgX + 100, y: cfgY + 70 };
  ov['cfg_watch']     = { x: cfgX - 80, y: cfgY + 210 };
  ov['vault']         = { x: cfgX - 30, y: cfgY + 210 };
  ov['utils']         = { x: cfgX + 50, y: cfgY + 210 };
  ov['analytics']     = { x: cfgX + 100, y: cfgY + 150 };
  ov['openapi']       = { x: cfgX + 100, y: cfgY + 210 };

  // Webhook Connect bottom-right
  const wcX = W - 240, wcY = oTop + oSpacing * 4.5;
  ov['wc_channel']   = { x: wcX, y: wcY };
  ov['wc_api']       = { x: wcX + 80, y: wcY + 60 };
  ov['wc_admin']     = { x: wcX - 80, y: wcY + 60 };
  ov['wc_models']    = { x: wcX - 50, y: wcY + 120 };
  ov['wc_buf_redis'] = { x: wcX + 30, y: wcY + 120 };
  ov['wc_buf_rmq']   = { x: wcX + 110, y: wcY + 120 };

  // Connector
  const cnX = W - 200, cnY = wcY + 200;
  ov['cn_main']      = { x: cnX, y: cnY };
  ov['cn_stream']    = { x: cnX - 80, y: cnY - 50 };
  ov['cn_proc']      = { x: cnX + 70, y: cnY + 50 };
  ov['cn_modproc']   = { x: cnX - 60, y: cnY + 50 };
  ov['cn_config']    = { x: cnX + 70, y: cnY - 30 };

  // ─── FLOW LAYOUT (vertical pipeline) ───
  const fl = VIEWS.flow.positions;
  fl['http']         = { x: cx, y: 90 };
  fl['main']         = { x: cx, y: 170 };
  fl['rate_limiter'] = { x: cx - 140, y: 230 };
  fl['webhook']      = { x: cx, y: 280 };
  fl['task_mgr']     = { x: cx + 160, y: 260 };
  fl['input_val']    = { x: cx - 130, y: 350 };
  fl['validators']   = { x: cx + 130, y: 350 };
  fl['registry']     = { x: cx - 80, y: 430 };
  fl['chain']        = { x: cx + 80, y: 430 };
  fl['chain_val']    = { x: cx + 200, y: 450 };
  fl['retry']        = { x: cx + 200, y: 400 };
  fl['base_mod']     = { x: cx - 220, y: 430 };

  const fmY = 540;
  moduleIds.forEach((id, i) => {
    const t = i / (moduleIds.length - 1);
    fl[id] = { x: cx - mSpread + t * mSpread * 2, y: fmY + Math.sin(t * Math.PI) * 40 };
  });

  // ─── MODULES LAYOUT (radial) ───
  const ml = VIEWS.modules.positions;
  ml['registry']  = { x: cx, y: cy - 50 };
  ml['base_mod']  = { x: cx, y: cy - 120 };
  ml['chain']     = { x: cx + 150, y: cy - 110 };
  ml['retry']     = { x: cx + 250, y: cy - 80 };
  ml['chain_val'] = { x: cx + 200, y: cy - 140 };
  ml['pool_reg']  = { x: cx - 150, y: cy - 110 };

  const mRad = Math.min(W, H) * 0.33;
  moduleIds.forEach((id, i) => {
    const angle = -Math.PI / 2 + (i / moduleIds.length) * Math.PI * 2;
    ml[id] = { x: cx + Math.cos(angle) * mRad, y: cy + 30 + Math.sin(angle) * mRad * 0.7 };
  });

  // ─── CONFIG LAYOUT ───
  const cl = VIEWS.config.positions;
  cl['main']         = { x: cx, y: 100 };
  cl['cfg_mgr']      = { x: cx, y: 220 };
  cl['cfg_provider'] = { x: cx - 100, y: 330 };
  cl['cfg_file']     = { x: cx - 200, y: 440 };
  cl['cfg_etcd']     = { x: cx,      y: 440 };
  cl['pool_reg']     = { x: cx + 160, y: 330 };
  cl['cfg_watch']    = { x: cx - 200, y: 540 };
  cl['vault']        = { x: cx - 60, y: 540 };
  cl['utils']        = { x: cx + 80, y: 540 };
}

// ── VIEW SWITCHING ────────────────────────────────────────────────────
function setView(view) {
  currentView = view;
  const v = VIEWS[view];
  flowStep = -1;
  flowTimer = 0;

  // Update buttons
  document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));

  // Update node targets
  NODES.forEach(n => {
    const node = nodeMap[n.id];
    const visible = !v.visible || v.visible.includes(n.id);
    const pos = v.positions[n.id];
    if (pos && visible) {
      node.tx = pos.x;
      node.ty = pos.y;
      node.talpha = 1;
      node.tscale = 1;
    } else {
      node.talpha = 0;
      node.tscale = 0.3;
    }
  });

  // Reset camera
  cameraX = 0; cameraY = 0; cameraScale = 1;

  // Start flow animation
  if (v.flowSteps) {
    flowStep = 0;
    flowTimer = 0;
    highlightFlowStep(0);
  }

  // Close detail panel
  closeDetail();
}

function highlightFlowStep(step) {
  const v = VIEWS[currentView];
  if (!v.flowSteps || step >= v.flowSteps.length) return;
  const fs = v.flowSteps[step];
  const label = document.getElementById('flow-label');
  label.textContent = fs.label;
  label.classList.add('visible');

  // All visible nodes stay fully opaque — no dimming
  NODES.forEach(n => {
    const node = nodeMap[n.id];
    if (!VIEWS[currentView].visible || VIEWS[currentView].visible.includes(n.id)) {
      node.talpha = 1;
    }
  });
}

// ── PARTICLES ─────────────────────────────────────────────────────────
function spawnParticles() {
  const v = VIEWS[currentView];
  EDGES.forEach(e => {
    if (!e.flow) return;
    const from = nodeMap[e.from], to = nodeMap[e.to];
    if (!from || !to || from.alpha < 0.2 || to.alpha < 0.2) return;
    if (Math.random() > 0.006) return;

    const cat = CATEGORIES[to.cat] || CATEGORIES[from.cat];
    particles.push({
      x: from.x, y: from.y,
      tx: to.x, ty: to.y,
      progress: 0,
      speed: 0.002 + Math.random() * 0.002,
      color: cat.color,
      size: 2 + Math.random() * 2,
      alpha: 0.8,
    });
  });
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.progress += p.speed;
    p.x = lerp(p.x, p.tx, p.speed * 2);
    p.y = lerp(p.y, p.ty, p.speed * 2);
    const dx = p.tx - p.x, dy = p.ty - p.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (p.progress >= 1 || dist < 3) {
      particles.splice(i, 1);
    }
  }
}

// ── DRAW ──────────────────────────────────────────────────────────────
function draw() {
  ctx.clearRect(0, 0, W, H);

  // Background grid
  drawGrid();

  ctx.save();
  ctx.translate(W / 2 + cameraX, H / 2 + cameraY);
  ctx.scale(cameraScale, cameraScale);
  ctx.translate(-W / 2, -H / 2);

  // Draw edges
  EDGES.forEach(e => drawEdge(e));

  // Draw particles
  particles.forEach(p => drawParticle(p));

  // Draw nodes (back to front by alpha to avoid overlap issues)
  const sorted = Object.values(nodeMap).sort((a, b) => a.alpha - b.alpha);
  sorted.forEach(n => drawNode(n));

  ctx.restore();
}

function drawGrid() {
  const spacing = 40 * cameraScale;
  const offX = (cameraX % spacing + spacing) % spacing;
  const offY = (cameraY % spacing + spacing) % spacing;
  ctx.strokeStyle = 'rgba(20,20,60,0.4)';
  ctx.lineWidth = 0.5;
  for (let x = offX; x < W; x += spacing) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = offY; y < H; y += spacing) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }
}

function drawEdge(e) {
  const from = nodeMap[e.from], to = nodeMap[e.to];
  if (!from || !to) return;
  const alpha = Math.min(from.alpha, to.alpha) * 0.4;
  if (alpha < 0.01) return;

  // Highlight if hovered/selected
  let highlight = false;
  if (hoveredNode && (e.from === hoveredNode.id || e.to === hoveredNode.id)) highlight = true;
  if (selectedNode && (e.from === selectedNode.id || e.to === selectedNode.id)) highlight = true;

  const cat = CATEGORIES[to.cat] || CATEGORIES.entry;
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);

  // Curved edges
  const mx = (from.x + to.x) / 2, my = (from.y + to.y) / 2;
  const dx = to.x - from.x, dy = to.y - from.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const curvature = Math.min(dist * 0.15, 30);
  const cx1 = mx + (dy > 0 ? curvature : -curvature) * 0.3;
  const cy1 = my;
  ctx.quadraticCurveTo(cx1, cy1, to.x, to.y);

  ctx.strokeStyle = highlight
    ? `rgba(${hexToRgb(cat.color)}, ${Math.min(alpha * 3, 0.8)})`
    : `rgba(${hexToRgb(cat.color)}, ${alpha})`;
  ctx.lineWidth = highlight ? 2 : 1;

  if (e.flow && highlight) {
    ctx.setLineDash([6, 4]);
    ctx.lineDashOffset = -time * 0.5;
  } else if (e.flow) {
    ctx.setLineDash([4, 6]);
    ctx.lineDashOffset = -time * 0.3;
  } else {
    ctx.setLineDash([2, 4]);
  }
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawParticle(p) {
  ctx.save();
  ctx.globalAlpha = p.alpha;
  ctx.shadowColor = p.color;
  ctx.shadowBlur = 8;
  ctx.fillStyle = p.color;
  ctx.beginPath();
  ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();
}

function drawNode(n) {
  if (n.alpha < 0.01) return;

  const cat = CATEGORIES[n.cat];
  const r = n.size * n.scale;
  const isHovered = hoveredNode && hoveredNode.id === n.id;
  const isSelected = selectedNode && selectedNode.id === n.id;
  const pulse = isHovered ? 1.15 + Math.sin(time * 0.06) * 0.05 : 1;
  const finalR = r * pulse;

  ctx.save();
  ctx.globalAlpha = n.alpha;

  // Glow
  const glowR = finalR * (isSelected ? 3 : isHovered ? 2.5 : 1.8);
  const grad = ctx.createRadialGradient(n.x, n.y, finalR * 0.5, n.x, n.y, glowR);
  grad.addColorStop(0, cat.glow);
  grad.addColorStop(1, 'transparent');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(n.x, n.y, glowR, 0, Math.PI * 2);
  ctx.fill();

  // Node body
  ctx.fillStyle = isSelected ? cat.color : isHovered ? cat.color : shadeColor(cat.color, -40);
  ctx.strokeStyle = cat.color;
  ctx.lineWidth = isSelected ? 2.5 : isHovered ? 2 : 1;
  ctx.shadowColor = cat.color;
  ctx.shadowBlur = isHovered ? 15 : 8;

  ctx.beginPath();
  // Rounded rectangle for larger nodes, circle for small
  if (r > 14) {
    roundRect(ctx, n.x - finalR * 1.4, n.y - finalR * 0.7, finalR * 2.8, finalR * 1.4, 6);
  } else {
    ctx.arc(n.x, n.y, finalR, 0, Math.PI * 2);
  }
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.stroke();

  // Label
  ctx.fillStyle = '#fff';
  ctx.font = `${Math.max(9, Math.min(12, r * 0.55))}px "Segoe UI", system-ui, sans-serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(n.label, n.x, n.y);

  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// ── ANIMATION LOOP ────────────────────────────────────────────────────
function animate() {
  if (!paused) {
    time++;
  }

  // Smooth node transitions (always run so view switches still animate)
  Object.values(nodeMap).forEach(n => {
    n.x = lerp(n.x, n.tx, 0.08);
    n.y = lerp(n.y, n.ty, 0.08);
    n.alpha = lerp(n.alpha, n.talpha, 0.06);
    n.scale = lerp(n.scale, n.tscale, 0.08);
    n.hover = lerp(n.hover, hoveredNode && hoveredNode.id === n.id ? 1 : 0, 0.1);
  });

  // Flow step animation
  const v = VIEWS[currentView];
  if (!paused && v.flowSteps && flowStep >= 0) {
    flowTimer++;
    if (flowTimer > 120) { // ~2s per step at 60fps
      flowTimer = 0;
      flowStep++;
      if (flowStep >= v.flowSteps.length) {
        flowStep = 0;
      }
      highlightFlowStep(flowStep);
    }
  }

  if (!paused) {
    spawnParticles();
    updateParticles();
  }
  draw();

  animFrame = requestAnimationFrame(animate);
}

// ── EVENTS ────────────────────────────────────────────────────────────
function bindEvents() {
  canvas.addEventListener('mousemove', onMouseMove);
  canvas.addEventListener('mousedown', onMouseDown);
  canvas.addEventListener('mouseup', onMouseUp);
  canvas.addEventListener('click', onClick);
  canvas.addEventListener('wheel', onWheel, { passive: false });
  canvas.addEventListener('mouseleave', () => { hoveredNode = null; hideTooltip(); isPanning = false; });

  document.querySelectorAll('.view-btn[data-view]').forEach(b => {
    b.addEventListener('click', () => setView(b.dataset.view));
  });
  document.getElementById('detail-close').addEventListener('click', closeDetail);

  const pauseBtn = document.getElementById('pause-btn');
  pauseBtn.addEventListener('click', () => {
    paused = !paused;
    pauseBtn.textContent = paused ? 'Play' : 'Pause';
    pauseBtn.classList.toggle('active', paused);
  });
}

function screenToWorld(sx, sy) {
  return {
    x: (sx - W / 2 - cameraX) / cameraScale + W / 2,
    y: (sy - H / 2 - cameraY) / cameraScale + H / 2,
  };
}

function hitTest(sx, sy) {
  const { x, y } = screenToWorld(sx, sy);
  let best = null, bestDist = Infinity;
  Object.values(nodeMap).forEach(n => {
    if (n.alpha < 0.2) return;
    const dx = n.x - x, dy = n.y - y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const hitR = Math.max(n.size * n.scale * 1.5, 20);
    if (dist < hitR && dist < bestDist) {
      best = n;
      bestDist = dist;
    }
  });
  return best;
}

function onMouseMove(e) {
  if (isPanning) {
    cameraX = panCamStartX + (e.clientX - panStartX);
    cameraY = panCamStartY + (e.clientY - panStartY);
    return;
  }
  if (dragNode) {
    const { x, y } = screenToWorld(e.clientX, e.clientY);
    dragNode.tx = x + dragOffX;
    dragNode.ty = y + dragOffY;
    dragNode.x = dragNode.tx;
    dragNode.y = dragNode.ty;
    // Update layout position
    const pos = VIEWS[currentView].positions[dragNode.id];
    if (pos) { pos.x = dragNode.tx; pos.y = dragNode.ty; }
    return;
  }

  const node = hitTest(e.clientX, e.clientY);
  hoveredNode = node;
  canvas.style.cursor = node ? 'pointer' : 'grab';

  if (node) {
    showTooltip(e.clientX, e.clientY, node);
  } else {
    hideTooltip();
  }
}

function onMouseDown(e) {
  const node = hitTest(e.clientX, e.clientY);
  if (node) {
    dragNode = node;
    const { x, y } = screenToWorld(e.clientX, e.clientY);
    dragOffX = node.x - x;
    dragOffY = node.y - y;
    canvas.style.cursor = 'grabbing';
  } else {
    isPanning = true;
    panStartX = e.clientX;
    panStartY = e.clientY;
    panCamStartX = cameraX;
    panCamStartY = cameraY;
    canvas.style.cursor = 'grabbing';
  }
}

function onMouseUp(e) {
  if (dragNode) savePositions();
  dragNode = null;
  isPanning = false;
  canvas.style.cursor = hitTest(e.clientX, e.clientY) ? 'pointer' : 'grab';
}

function onClick(e) {
  const node = hitTest(e.clientX, e.clientY);
  if (node && node.alpha > 0.2) {
    selectedNode = node;
    openDetail(node);
  } else if (!isPanning) {
    selectedNode = null;
    closeDetail();
  }
}

function onWheel(e) {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.92 : 1.08;
  const newScale = Math.max(0.3, Math.min(3, cameraScale * delta));
  // Zoom toward mouse
  const mx = e.clientX - W / 2;
  const my = e.clientY - H / 2;
  cameraX = mx - (mx - cameraX) * (newScale / cameraScale);
  cameraY = my - (my - cameraY) * (newScale / cameraScale);
  cameraScale = newScale;
}

// ── TOOLTIP ───────────────────────────────────────────────────────────
function showTooltip(mx, my, node) {
  const tt = document.getElementById('tooltip');
  tt.querySelector('.tt-name').textContent = node.label;
  tt.querySelector('.tt-role').textContent = CATEGORIES[node.cat].label + (node.file ? ' — ' + node.file : '');
  tt.style.left = (mx + 16) + 'px';
  tt.style.top = (my - 10) + 'px';
  tt.classList.add('visible');
}
function hideTooltip() {
  document.getElementById('tooltip').classList.remove('visible');
}

// ── DETAIL PANEL ──────────────────────────────────────────────────────
function openDetail(node) {
  const panel = document.getElementById('detail');
  const cat = CATEGORIES[node.cat];
  document.getElementById('detail-title').textContent = node.label;

  const connections = [];
  EDGES.forEach(e => {
    if (e.from === node.id && nodeMap[e.to]) connections.push({ dir: 'out', node: nodeMap[e.to], label: e.label });
    if (e.to === node.id && nodeMap[e.from]) connections.push({ dir: 'in', node: nodeMap[e.from], label: e.label });
  });

  let html = '';
  html += `<div class="label">Category</div>`;
  html += `<div class="value"><span class="category-badge" style="background:${cat.glow};color:${cat.color};border:1px solid ${cat.color}">${cat.label}</span></div>`;

  if (node.file) {
    html += `<div class="label">File</div>`;
    html += `<div class="value filepath">${node.file}</div>`;
  }

  html += `<div class="label">Description</div>`;
  html += `<div class="value">${node.desc}</div>`;

  if (connections.length > 0) {
    const incoming = connections.filter(c => c.dir === 'in');
    const outgoing = connections.filter(c => c.dir === 'out');

    if (incoming.length > 0) {
      html += `<div class="label">Receives from (${incoming.length})</div>`;
      html += `<div class="conn-list">`;
      incoming.forEach(c => {
        html += `<span class="conn-item" style="border-color:${CATEGORIES[c.node.cat].color}40;background:${CATEGORIES[c.node.cat].color}15;color:${CATEGORIES[c.node.cat].color}">${c.node.label}${c.label ? ' — ' + c.label : ''}</span>`;
      });
      html += `</div>`;
    }

    if (outgoing.length > 0) {
      html += `<div class="label">Sends to (${outgoing.length})</div>`;
      html += `<div class="conn-list">`;
      outgoing.forEach(c => {
        html += `<span class="conn-item" style="border-color:${CATEGORIES[c.node.cat].color}40;background:${CATEGORIES[c.node.cat].color}15;color:${CATEGORIES[c.node.cat].color}">${c.node.label}${c.label ? ' — ' + c.label : ''}</span>`;
      });
      html += `</div>`;
    }
  }

  document.getElementById('detail-body').innerHTML = html;
  panel.classList.add('open');
  document.getElementById('stats').classList.add('shifted');
}

function closeDetail() {
  document.getElementById('detail').classList.remove('open');
  document.getElementById('stats').classList.remove('shifted');
  selectedNode = null;
}

// ── HELPERS ───────────────────────────────────────────────────────────
function lerp(a, b, t) { return a + (b - a) * t; }

function hexToRgb(hex) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `${r},${g},${b}`;
}

function shadeColor(hex, amt) {
  let r = parseInt(hex.slice(1, 3), 16) + amt;
  let g = parseInt(hex.slice(3, 5), 16) + amt;
  let b = parseInt(hex.slice(5, 7), 16) + amt;
  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));
  return `rgb(${r},${g},${b})`;
}

// ── PERSISTENCE (localStorage) ────────────────────────────────────────
const STORAGE_KEY = 'cwm-viz-positions';

function savePositions() {
  const data = {};
  for (const view in VIEWS) {
    data[view] = {};
    for (const id in VIEWS[view].positions) {
      const p = VIEWS[view].positions[id];
      data[view][id] = { x: Math.round(p.x), y: Math.round(p.y) };
    }
  }
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {}
}

function restorePositions() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    for (const view in data) {
      if (!VIEWS[view]) continue;
      for (const id in data[view]) {
        if (VIEWS[view].positions[id]) {
          VIEWS[view].positions[id].x = data[view][id].x;
          VIEWS[view].positions[id].y = data[view][id].y;
        }
      }
    }
  } catch (e) {}
}

// ── BOOT ──────────────────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>